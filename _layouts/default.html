<!DOCTYPE html>
<html lang="en">
{% include head.html %}
<body>

  <!-- Konten SPA -->
  <div id="page_holder">
    {{ content }} <!-- Konten homepage langsung muncul -->
  </div>

<script>
const pageHolder = document.getElementById('page_holder');
const base = "{{ site.baseurl }}"; // "/mouse"

/* =========================
   RENDER 404 (STATE RESMI)
========================= */
function render404(push = true) {
  pageHolder.innerHTML = `
    <div class="page-content active" style="padding:2em;background:#fee;color:#900">
      <h1>404</h1>
      <p>Halaman tidak ditemukan.</p>
      <a href="${base}/">Kembali ke Home</a>
    </div>
  `;

  if (push) {
    history.pushState({ path: '/404' }, '', base + '/404');
  }
}

/* =========================
   LOAD PAGE
========================= */
function loadPage(url, push = true) {
  fetch(url)
    .then(res => {
      if (!res.ok) throw new Error('404');
      return res.text();
    })
    .then(html => {
      html = html.replace(/<footer[\s\S]*?<\/footer>/gi, '');

      const wrapper = document.createElement('div');
      wrapper.className = 'page-content';
      wrapper.innerHTML = html;

      pageHolder.innerHTML = '';
      pageHolder.appendChild(wrapper);

      wrapper.getBoundingClientRect();
      wrapper.classList.add('active');

      window.scrollTo(0, 0);
      attachLinkListeners();

      if (push) {
        history.pushState(
          { path: url.replace(base,'') || '/' },
          '',
          url
        );
      }
    })
    .catch(() => {
      render404(push);
    });
}

/* =========================
   INTERCEPT LINK
========================= */
function attachLinkListeners() {
  document.querySelectorAll('a[href^="/"]').forEach(a => {
    if (a.dataset.spa) return;

    if (!a.href.startsWith(window.location.origin)) return;
    if (a.target === '_blank') return;

    a.dataset.spa = "true";

    a.addEventListener('click', e => {
      e.preventDefault();
      let url = a.getAttribute('href');

      if (!url.startsWith(base)) {
        url = base + url;
      }

      loadPage(url, true);
    });
  });
}

/* =========================
   BACK / FORWARD
========================= */
window.addEventListener('popstate', e => {
  if (!e.state || e.state.path === '/404') {
    render404(false);
    return;
  }

  const path = base + e.state.path;
  loadPage(path, false);
});

/* =========================
   INITIAL LOAD
========================= */
window.addEventListener('DOMContentLoaded', () => {
  attachLinkListeners();

  const path = location.pathname;

  if (path.endsWith('/404')) {
    render404(false);
  } else {
    loadPage(path, false);
  }
});
</script>

<footer class="site-footer">
  <p>&copy; 2025 Apip. All rights reserved.</p>
  <nav>
    <a href="{{ '/' | relative_url }}">Home</a> |
    <a href="{{ '/blog/' | relative_url }}">Blog</a> |
    <a href="{{ '/about' | relative_url }}">About</a>
  </nav>
</footer>

</body>
</html>
