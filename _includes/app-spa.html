<script>
/* =========================
   SETUP (ini penanda update)
========================= */
const pageHolder = document.getElementById('page_holder');
const base = "{{ site.baseurl }}"; // "/mouse"

if ('scrollRestoration' in history) {
  history.scrollRestoration = 'manual';
}

/* =========================
   SCROLL MEMORY
========================= */
function saveScroll() {
  sessionStorage.setItem(
    'scroll:' + location.pathname,
    window.scrollY
  );
}

function restoreScroll() {
  const y = sessionStorage.getItem(
    'scroll:' + location.pathname
  );
  if (y !== null) {
    window.scrollTo(0, parseInt(y, 10));
  }
}

/* =========================
   LOAD PAGE
========================= */
function loadPage(url, push = true) {
  const oldPage = pageHolder.querySelector('.page-content');

  if (oldPage) {
    oldPage.classList.remove('enter');
    oldPage.classList.add('exit');
  }

  fetch(url)
    .then(res => {
      if (!res.ok) throw new Error('Page not found');
      return res.text();
    })
    .then(html => {
      html = html.replace(/<footer[\s\S]*?<\/footer>/gi, '');

      const wrapper = document.createElement('div');
      wrapper.className = 'page-content';
      wrapper.innerHTML = html;

      setTimeout(() => {
        pageHolder.innerHTML = '';
        pageHolder.appendChild(wrapper);

        wrapper.getBoundingClientRect();
        wrapper.classList.add('enter');

        if (push) {
          window.scrollTo(0, 0);      // klik link â†’ ke atas
        } else {
          restoreScroll();            // reload / back / forward
        }

        attachLinkListeners();
        initTextareaApp?.();
        initBreadcrumb?.(url);

        if (push) {
          history.pushState({ url }, '', url);
        }
      }, oldPage ? 300 : 0);
    })
    .catch(() => {
      show404(push);
    });
}

/* =========================
   404 STATE
========================= */
function show404(push = true) {
  pageHolder.innerHTML = `
    <div class="page-404">
      <h1>404</h1>
      <p>Halaman tidak ditemukan.</p>
      <a href="${base}/">Kembali ke Home</a>
    </div>
  `;

  const box = pageHolder.querySelector('.page-404');
  box.getBoundingClientRect();
  box.classList.add('show');

  attachLinkListeners();

  if (push) {
    history.pushState(
      { url: base + '/404' },
      '',
      base + '/404'
    );
  }
}

/* =========================
   INTERCEPT LINK
========================= */
function attachLinkListeners() {
  document.querySelectorAll('a[href^="/"]').forEach(a => {
    if (a.dataset.spa) return;
    if (!a.href.startsWith(location.origin)) return;
    if (a.target === '_blank') return;

    a.dataset.spa = "true";

    a.addEventListener('click', e => {
      e.preventDefault();

      saveScroll(); // ðŸ”‘ SIMPAN POSISI

      let url = a.getAttribute('href');
      if (!url.startsWith(base)) {
        url = base + url;
      }

      loadPage(url, true);
    });
  });
}

/* =========================
   BACK / FORWARD
========================= */
window.addEventListener('popstate', () => {
  loadPage(location.pathname, false);
});

/* =========================
   RELOAD / F5
========================= */
window.addEventListener('beforeunload', saveScroll);
window.addEventListener('load', restoreScroll);

/* =========================
   INITIAL LOAD
========================= */
window.addEventListener('DOMContentLoaded', () => {
  attachLinkListeners();
  loadPage(location.pathname, false);
});
</script>
